ðŸ”¹ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ð°
# ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ñ Ñ‚Ð²Ð¾Ð¸Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ¼
cd /Ð¿ÑƒÑ‚ÑŒ/Ðº/Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ/Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÑŽ

# Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹)
cp Makefile Makefile.bak
cp helm/values.yaml helm/values.yaml.bak
cp .github/workflows/cicd.yaml .github/workflows/cicd.yaml.bak

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Makefile
cat > Makefile << 'EOF'
REGISTRY=ghcr.io
REPO=den-vasyliev/kbot       # <- Ð·Ð°Ð¼ÐµÐ½Ð¸ Ð½Ð° ÑÐ²Ð¾Ð¹ GitHub username
OS=linux
ARCH=amd64
TAG=$(shell git describe --tags --always)-$(OS)-$(ARCH)

build:
	docker buildx build --platform $(OS)/$(ARCH) -t $(REGISTRY)/$(REPO):$(TAG) .

push:
	docker push $(REGISTRY)/$(REPO):$(TAG)

helm-update:
	@sed -i "s|tag:.*|tag: \"$(TAG)\"|g" helm/values.yaml
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ helm/values.yaml
cat > helm/values.yaml << 'EOF'
image:
  registry: "ghcr.io"
  repository: "den-vasyliev/kbot"   # <- Ð·Ð°Ð¼ÐµÐ½Ð¸ Ð½Ð° ÑÐ²Ð¾Ð¹ GitHub username
  tag: "v1.0.0-106879e"
  os: linux
  arch: amd64

replicaCount: 1
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ workflow
mkdir -p .github/workflows
cat > .github/workflows/cicd.yaml << 'EOF'
name: CI/CD Pipeline

on:
  push:
    branches:
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        run: |
          make build
          make push

      - name: Update Helm values
        run: |
          make helm-update
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add helm/values.yaml
          git commit -m "Update image tag"
          git push

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd /usr/local/bin/argocd

      - name: Sync ArgoCD
        run: |
          argocd app sync kbot \
            --auth-token ${{ secrets.ARGOCD_TOKEN }} \
            --server ${{ secrets.ARGOCD_SERVER }}
EOF

# Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
git add Makefile helm/values.yaml .github/workflows/cicd.yaml

# Ð—Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑŒ
git commit -m "Fix GHCR repo, update workflow with ArgoCD CLI"

# Ð—Ð°Ð¿ÑƒÑˆÐ¸Ñ‚ÑŒ Ð² develop
git push origin develop

âœ… Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚

Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð±ÑÐºÐ°Ð¿ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸.

ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Makefile Ð¸ helm/values.yaml Ñ Ñ‚Ð²Ð¾Ð¸Ð¼ GHCR namespace.

Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ ÑˆÐ°Ð³ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ArgoCD CLI Ð² workflow.

ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ Ð¸ Ð¿ÑƒÑˆÐ¸Ñ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð²ÐµÑ‚ÐºÑƒ develop.

ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ð¾Ð³Ð¾ GitHub Actions Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ CI/CD Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½.
